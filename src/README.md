# LinuxMonitoring v2.0

Мониторинг и исследование состояния системы в реальном времени.

Каждое задание x расположено в 0x/main.sh.

Запуск на Ubuntu 20.04.4 LTS.

## Contents

1. [Генератор файлов](#part-1-генератор-файлов)  
2. [Засорение файловой системы](#part-2-засорение-файловой-системы)  
3. [Очистка файловой системы](#part-3-очистка-файловой-системы)  
4. [Генератор логов](#part-4-генератор-логов)  
5. [Мониторинг](#part-5-мониторинг)  
6. [GoAccess](#part-6-goaccess)  
7. [Prometheus и Grafana](#part-7-prometheus-и-grafana)  
8. [Готовый дашборд](#part-8-готовый-дашборд)  
9. [Дополнительно. Свой node_exporter](#part-9-дополнительно-свой-node_exporter)  

## Part 1. Генератор файлов

> Скрипт генерирует файлы заданного размера в указанной директории. В качестве параметров также передаются символы для генерации имен папок и файлов и количество папок и файлов в них.

- Пример. В папке /home/loretath/shared/01/buf/ будет сгенерировано 5 папок (abcd, aabcd, abbcd, abccd, abcdd), в каждой будет по 3 файла (qwer.txt, qqwer.txt, qwwer.txt), по 23 килобайта каждый.

```bash
bash main.sh /home/loretath/shared/01/buf 5 abcd 3 qwer.txt 23
```

_Информация о созданных файлах записывается в access_log в той директории, где был запущен скрипт._

## Part 2. Засорение файловой системы

> Скрипт генерирует файлы по всей системе до тех пор, пока больше 1 Гб свободного места в корневой директории. На ввод принимаются символы для имен директорий, файлов (с расширением) и размер в Mb. 

```sh
bash main.sh az az.az 3Mb
```
_Информация о созданных файлах записывается в access_log в той директории, где был запущен скрипт._

## Part 3. Очистка файловой системы

> Скрипт чистит систему тремя способами: 1) по файлу с логами; 2) по времени создания (не затрагивает системных); 3) по маске, используемой в пунктах выше.

- Протестировать можно, запустив скрипт test.sh (less для удобства просмотра вывода):

```sh
bash test.sh | less
```

## Part 4. Генератор логов

> Скрпит генерирует 5 файлов с логами nginx в combined формате.

|http-код| Значение |
|--|--|
|200|OK|
|201|Created|
|400|Bad Request|
|401|Unauthorized|
|403|Forbidden|
|404|Not Found|
|500|Internal Server Error|
|501|Not Implemented|
|502|Bad Gateway|
|503|Service Unavailable|

## Part 5. Мониторинг

> Простой анализ логов в терминале. В зависимости от выбранной аргументы скрипт выведет: 
1 - Все записи, отсортированные по коду ответа;
2 - Все уникальные IP, встречающиеся в записях;
3 - Все запросы с ошибками (код ответа - 4хх или 5хх);
4 - Все уникальные IP, которые встречаются среди ошибочных запросов.



- Протестировать можно через готовый скрипт test.sh

```sh
bash test.sh
```

## Part 6. **GoAccess**

> Воспользуемся готовой утилитой для анализа из прошлой логов. Установим goaccess на ubuntu и сгенерируем html-страничку с анализом логов.

```sh
html_output="logs_report.html"

if ! [[ -n $(dpkg -l | grep goaccess) ]];
then sudo apt install -y goaccess
fi

sudo touch $html_output && chmod 777 $html_output
goaccess ../04/access*.log --log-format=COMBINED > ./$html_output
```

![](../../misc/images/6.png)
